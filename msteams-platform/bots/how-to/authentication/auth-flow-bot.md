---
title: Microsoft Teamsボットの認証フロー
description: ボットのMicrosoft Teams認証フローについて説明します。
keywords: チーム認証フロー ボット
localization_priority: Normal
ms.topic: overview
ms.openlocfilehash: f3bf73c105dc38e1cea515bfa7bb7d5324b02ce4
ms.sourcegitcommit: 51e4a1464ea58c254ad6bd0317aca03ebf6bf1f6
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/19/2021
ms.locfileid: "52565905"
---
# <a name="authentication-flow-for-bots-in-microsoft-teams"></a><span data-ttu-id="fa864-104">Microsoft Teamsのボットの認証フロー</span><span class="sxs-lookup"><span data-stu-id="fa864-104">Authentication flow for bots in Microsoft Teams</span></span>

<span data-ttu-id="fa864-105">OAuth 2.0 は、Azure Active Directory (Azure AD) および他の多くの ID プロバイダーが使用する認証および承認のオープン スタンダードです。</span><span class="sxs-lookup"><span data-stu-id="fa864-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure Active Directory (Azure AD) and many other identity providers.</span></span> <span data-ttu-id="fa864-106">OAuth 2.0 の基本知識は、Teamsで認証を操作するための前提条件です。正式な[仕様](https://oauth.net/2/)よりも簡単に従う[良い概要を次に示](https://aaronparecki.com/oauth-2-simplified/)します。</span><span class="sxs-lookup"><span data-stu-id="fa864-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="fa864-107">タブとボットの認証フローは少し異なります — タブはウェブサイトと非常によく似ているので、OAuth 2.0 を直接使用できますが、ボットは異なる方法で実行する必要はありませんが、コア概念は同じです。</span><span class="sxs-lookup"><span data-stu-id="fa864-107">Authentication flow for tabs and bots is a little different — tabs are very similar to websites so they can use OAuth 2.0 directly, while bots aren't and must do a few things differently — but the core concepts are identical.</span></span>

<span data-ttu-id="fa864-108">Node.js と[OAuth 2.0 承認コード許可タイプ](https://oauth.net/2/grant-types/authorization-code/)を使用するボットの認証フローを示す例については、「GitHubレポ[Microsoft Teams認証サンプル](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="fa864-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/Microsoft-Teams-Samples/tree/main/samples/app-auth/nodejs) for an example that demonstrates authentication flow for bots using Node.js and the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![ボット認証シーケンス図](../../../assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="fa864-110">ユーザーがボットにメッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="fa864-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="fa864-111">ボットは、ユーザーがサインインする必要があるかどうかを判断します。</span><span class="sxs-lookup"><span data-stu-id="fa864-111">The bot determines if the user needs to sign in.</span></span>
   <span data-ttu-id="fa864-112">この例では、ボットはアクセス トークンをユーザー データ ストアに格納します。</span><span class="sxs-lookup"><span data-stu-id="fa864-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="fa864-113">選択した ID プロバイダーの検証済みトークンがない場合は、サインインするようにユーザーに要求します。</span><span class="sxs-lookup"><span data-stu-id="fa864-113">It asks the user to sign in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="fa864-114">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span><span class="sxs-lookup"><span data-stu-id="fa864-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="fa864-115">ボットは、認証フローの開始ページへの URL を構築し、アクションを持つカードをユーザーに送信 `signin` します。</span><span class="sxs-lookup"><span data-stu-id="fa864-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="fa864-116">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span><span class="sxs-lookup"><span data-stu-id="fa864-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span></br>
    <span data-ttu-id="fa864-117">Teamsの他のアプリケーション認証フローと同様に、スタート ページは、リスト上のドメイン `validDomains` と、ログイン後のリダイレクト ページと同じドメインに存在する必要があります。</span><span class="sxs-lookup"><span data-stu-id="fa864-117">Like other application auth flows in Teams, the start page must be in a domain that's on your `validDomains` list, and in the same domain as the post-login redirect page.</span></span>
    > [!IMPORTANT] 
    > <span data-ttu-id="fa864-118">OAuth 2.0 承認コード許可フローは、 `state` [クロスサイトリクエストフォージェリ攻撃](https://en.wikipedia.org/wiki/Cross-site_request_forgery)を防ぐために一意のセッショントークンを含む認証リクエストのパラメータを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="fa864-118">The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="fa864-119">この例では、ランダムに生成された GUID を使用します。</span><span class="sxs-lookup"><span data-stu-id="fa864-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="fa864-120">ユーザーが *サインイン* ボタンを選択すると、ポップアップ ウィンドウTeams開き、スタート ページに移動します。</span><span class="sxs-lookup"><span data-stu-id="fa864-120">When the user selects the *signin* button, Teams opens a popup window and navigates to the start page.</span></span>
   > [!NOTE]
   > <span data-ttu-id="fa864-121">ポップアップ ウィンドウのサイズは、URL の幅と高さのクエリ文字列パラメーターを使用して制御できます。</span><span class="sxs-lookup"><span data-stu-id="fa864-121">The size of the pop-up window can be controlled through width and height query string parameters in the URL.</span></span> <span data-ttu-id="fa864-122">たとえば、width=500 と height=500 を追加すると、ポップアップ ウィンドウのサイズは 500 x 500 ピクセルになります。</span><span class="sxs-lookup"><span data-stu-id="fa864-122">For example, if you add width=500 and height=500, the size of the pop-up window is 500x500 pixels.</span></span> <span data-ttu-id="fa864-123">Teams、指定されたピクセル サイズのポップアップ ウィンドウが、メイン ウィンドウのサイズに対するパーセンテージの最大値まで表示されます。</span><span class="sxs-lookup"><span data-stu-id="fa864-123">Teams displays the pop-up window with the given pixel size, up to a maximum that's a percentage of the size of the main window.</span></span>

5. <span data-ttu-id="fa864-124">開始ページは、ユーザーを ID プロバイダーのエンドポイントにリダイレクト `authorize` します。</span><span class="sxs-lookup"><span data-stu-id="fa864-124">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="fa864-125">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span><span class="sxs-lookup"><span data-stu-id="fa864-125">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="fa864-126">プロバイダーのサイトで、ユーザーはサインインし、ボットへのアクセスを許可します。</span><span class="sxs-lookup"><span data-stu-id="fa864-126">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="fa864-127">プロバイダーは、承認コードを使用して、ボットの OAuth リダイレクト ページにユーザーを移動します。</span><span class="sxs-lookup"><span data-stu-id="fa864-127">The provider takes the user to the bot's OAuth redirect page with an authorization code.</span></span>
8. <span data-ttu-id="fa864-128">ボットはアクセス トークンの認証コードを使用し、サインイン フローを開始したユーザーに **トークンを暫定的に** 関連付けます。</span><span class="sxs-lookup"><span data-stu-id="fa864-128">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="fa864-129">以下では、これを *暫定トークン* と呼びます。</span><span class="sxs-lookup"><span data-stu-id="fa864-129">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="fa864-130">この例では、ボットは `state` 、パラメーターの値をサインイン プロセスを開始したユーザーの ID と関連付け、後で `state` ID プロバイダーが返す値と一致できるようにします。</span><span class="sxs-lookup"><span data-stu-id="fa864-130">In the example, the bot associates the value of the `state` parameter with the ID of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="fa864-131">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span><span class="sxs-lookup"><span data-stu-id="fa864-131">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
      > [!IMPORTANT] 
      > <span data-ttu-id="fa864-132">ボットは、ID プロバイダーから受け取ったトークンを格納し、特定のユーザーに関連付けますが、"保留中の検証" としてマークされます。</span><span class="sxs-lookup"><span data-stu-id="fa864-132">The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> 
    * <span data-ttu-id="fa864-133">暫定トークンは、さらに検証しないと使用できません。</span><span class="sxs-lookup"><span data-stu-id="fa864-133">The provisional token can't be used without further validation.</span></span>
      1. <span data-ttu-id="fa864-134">**ID プロバイダーから受け取った内容を検証します。**</span><span class="sxs-lookup"><span data-stu-id="fa864-134">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="fa864-135">パラメータの値は `state` 、以前に保存された値と照合して確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="fa864-135">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="fa864-136">**Teamsから受け取った内容を検証します。**</span><span class="sxs-lookup"><span data-stu-id="fa864-136">**Validate what's received from Teams.**</span></span> <span data-ttu-id="fa864-137">ID プロバイダーでボットを承認したユーザーが、ボットとチャットしているユーザーと同じであることを確認するために [、2 段階の認証](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) 検証が実行されます。</span><span class="sxs-lookup"><span data-stu-id="fa864-137">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="fa864-138">これは [、中間者](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) と [フィッシング](https://en.wikipedia.org/wiki/Phishing) 攻撃から保護します。</span><span class="sxs-lookup"><span data-stu-id="fa864-138">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="fa864-139">ボットは検証コードを生成し、ユーザーに関連付けられたコードを保存します。</span><span class="sxs-lookup"><span data-stu-id="fa864-139">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="fa864-140">確認コードは、以下のTeamsによって自動的に送信されます。</span><span class="sxs-lookup"><span data-stu-id="fa864-140">The verification code is sent automatically by Teams as described below.</span></span> <span data-ttu-id="fa864-141">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span><span class="sxs-lookup"><span data-stu-id="fa864-141">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="fa864-142">OAuth コールバックは、 を呼び出すページをレンダリング `notifySuccess("<verification code>")` します。</span><span class="sxs-lookup"><span data-stu-id="fa864-142">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="fa864-143">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span><span class="sxs-lookup"><span data-stu-id="fa864-143">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="fa864-144">Teamsポップアップ ウィンドウを閉じ、 `<verification code>` 送信したメッセージを `notifySuccess()` ボットに送信します。</span><span class="sxs-lookup"><span data-stu-id="fa864-144">Teams closes the pop-up window and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="fa864-145">ボットは、 と共に [呼び出し](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) メッセージを受信 `name = signin/verifyState` します。</span><span class="sxs-lookup"><span data-stu-id="fa864-145">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="fa864-146">ボットは、ユーザーの仮トークンに保存されている確認コードに対して受信確認コードをチェックします。</span><span class="sxs-lookup"><span data-stu-id="fa864-146">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="fa864-147">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span><span class="sxs-lookup"><span data-stu-id="fa864-147">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="fa864-148">一致する場合、ボットはトークンを検証済みで使用できる状態としてマークします。</span><span class="sxs-lookup"><span data-stu-id="fa864-148">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="fa864-149">それ以外の場合、認証フローは失敗し、ボットは暫定トークンを削除します。</span><span class="sxs-lookup"><span data-stu-id="fa864-149">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

    > [!NOTE]
    > <span data-ttu-id="fa864-150">モバイルでの認証に関する問題が発生した場合は、JavaScript SDK がバージョン 1.4.1 以降に更新されていることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="fa864-150">If you experience issues with authentication on mobile, ensure your JavaScript SDK is updated to version 1.4.1 or later.</span></span>

## <a name="code-sample"></a><span data-ttu-id="fa864-151">コード サンプル</span><span class="sxs-lookup"><span data-stu-id="fa864-151">Code sample</span></span>

<span data-ttu-id="fa864-152">ボット認証プロセスを示すサンプル コード:</span><span class="sxs-lookup"><span data-stu-id="fa864-152">Sample code showing the bot authentication process:</span></span>

| <span data-ttu-id="fa864-153">**サンプル名**</span><span class="sxs-lookup"><span data-stu-id="fa864-153">**Sample name**</span></span> | <span data-ttu-id="fa864-154">**説明**</span><span class="sxs-lookup"><span data-stu-id="fa864-154">**Description**</span></span> | <span data-ttu-id="fa864-155">**Node.js**</span><span class="sxs-lookup"><span data-stu-id="fa864-155">**Node.js**</span></span> | <span data-ttu-id="fa864-156">**.NET**</span><span class="sxs-lookup"><span data-stu-id="fa864-156">**.NET**</span></span> | <span data-ttu-id="fa864-157">**Python**</span><span class="sxs-lookup"><span data-stu-id="fa864-157">**Python**</span></span> |
|-----------------|----------------|--------------|----------|-----------|
| <span data-ttu-id="fa864-158">Teams認証</span><span class="sxs-lookup"><span data-stu-id="fa864-158">Teams authentication</span></span> | <span data-ttu-id="fa864-159">このサンプルでは、Microsoft Teams アプリでの認証を示します。</span><span class="sxs-lookup"><span data-stu-id="fa864-159">This sample demonstrates authentication in Microsoft Teams apps.</span></span> | [<span data-ttu-id="fa864-160">View</span><span class="sxs-lookup"><span data-stu-id="fa864-160">View</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) | | |
| <span data-ttu-id="fa864-161">ボット認証</span><span class="sxs-lookup"><span data-stu-id="fa864-161">Bot authentication</span></span> | <span data-ttu-id="fa864-162">このサンプルでは、Microsoft Teamsで実行するボットに認証を使用する方法を実証します。</span><span class="sxs-lookup"><span data-stu-id="fa864-162">This sample demonstartes how to use authentication for a bot runnning in Microsoft Teams</span></span> | [<span data-ttu-id="fa864-163">View</span><span class="sxs-lookup"><span data-stu-id="fa864-163">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/javascript_nodejs/46.teams-auth) | [<span data-ttu-id="fa864-164">View</span><span class="sxs-lookup"><span data-stu-id="fa864-164">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/csharp_dotnetcore/46.teams-auth) | [<span data-ttu-id="fa864-165">View</span><span class="sxs-lookup"><span data-stu-id="fa864-165">View</span></span>](https://github.com/microsoft/BotBuilder-Samples/tree/main/samples/python/46.teams-auth)

## <a name="see-also"></a><span data-ttu-id="fa864-166">関連項目</span><span class="sxs-lookup"><span data-stu-id="fa864-166">See also</span></span>

[<span data-ttu-id="fa864-167">Teamsボットに認証を追加する</span><span class="sxs-lookup"><span data-stu-id="fa864-167">Add authentication to your Teams bot</span></span>](add-authentication.md)
