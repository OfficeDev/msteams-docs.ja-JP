---
title: ボットの認証フロー
description: ボットの認証フローについて説明します。
keywords: teams 認証フローボット
ms.date: 03/01/2018
ms.openlocfilehash: 40f34a3b51349cc1d11f819a92b479a92ebac149
ms.sourcegitcommit: 4329a94918263c85d6c65ff401f571556b80307b
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/01/2020
ms.locfileid: "41675033"
---
# <a name="microsoft-teams-authentication-flow-for-bots"></a><span data-ttu-id="7627c-104">ボットの Microsoft Teams 認証フロー</span><span class="sxs-lookup"><span data-stu-id="7627c-104">Microsoft Teams authentication flow for bots</span></span>

<span data-ttu-id="7627c-105">OAuth 2.0 は、Azure Active Directory (Azure AD) とその他の多くの id プロバイダーによって使用される認証と承認のためのオープン標準です。</span><span class="sxs-lookup"><span data-stu-id="7627c-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure Active Directory (Azure AD) and many other identity providers.</span></span> <span data-ttu-id="7627c-106">OAuth 2.0 に関する基本的な理解は、Teams で認証を使用するための前提条件です。[正式な仕様](https://oauth.net/2/)よりも簡単に理解できる[概要を](https://aaronparecki.com/oauth-2-simplified/)次に示します。</span><span class="sxs-lookup"><span data-stu-id="7627c-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="7627c-107">タブとボットの認証フローは少し異なります。タブは、OAuth 2.0 を直接使用できるようにするために、web サイトと非常によく似ていますが、ボットはまったく異なるものにする必要はありませんが、コア概念は同じです。</span><span class="sxs-lookup"><span data-stu-id="7627c-107">Authentication flow for tabs and bots is a little different — tabs are very similar to websites so they can use OAuth 2.0 directly, while bots aren't and must do a few things differently — but the core concepts are identical.</span></span>

<span data-ttu-id="7627c-108">Node.js を使用したボットの認証フロー、および[OAuth 2.0 認証コード許可の種類](https://oauth.net/2/grant-types/authorization-code/)を示す例については、「GitHub リポジトリの[Microsoft Teams 認証サンプル](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7627c-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) for an example that demonstrates authentication flow for bots using Node.js and the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![Bot 認証シーケンス図](../../../assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="7627c-110">ユーザーが bot にメッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="7627c-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="7627c-111">Bot は、ユーザーがサインインする必要があるかどうかを判断します。</span><span class="sxs-lookup"><span data-stu-id="7627c-111">The bot determines if the user needs to sign in.</span></span>
    * <span data-ttu-id="7627c-112">この例では、bot はユーザーデータストアにアクセストークンを格納します。</span><span class="sxs-lookup"><span data-stu-id="7627c-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="7627c-113">選択した id プロバイダーの検証済みトークンがない場合は、ユーザーにサインインを求めるメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="7627c-113">It asks the user to sign in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="7627c-114">([ビューコード](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span><span class="sxs-lookup"><span data-stu-id="7627c-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="7627c-115">Bot は、認証フローの開始ページの URL を構築し、 `signin`アクションを使用してユーザーにカードを送信します。</span><span class="sxs-lookup"><span data-stu-id="7627c-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="7627c-116">([ビューコード](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span><span class="sxs-lookup"><span data-stu-id="7627c-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span>
    * <span data-ttu-id="7627c-117">Teams での他のアプリケーション認証フローと同様に、開始ページは、 `validDomains`リスト上のドメイン内にあり、ログイン後リダイレクトページと同じドメイン内にある必要があります。</span><span class="sxs-lookup"><span data-stu-id="7627c-117">Like other application auth flows in Teams, the start page must be in a domain that's on your `validDomains` list, and in the same domain as the post-login redirect page.</span></span>
    * <span data-ttu-id="7627c-118">**重要**: OAuth 2.0 認証コードは、 `state` [クロスサイト要求偽造攻撃](https://en.wikipedia.org/wiki/Cross-site_request_forgery)を防止するための一意のセッショントークンを含む、認証要求のパラメーターに対して、要求フローの呼び出しを許可します。</span><span class="sxs-lookup"><span data-stu-id="7627c-118">**IMPORTANT**: The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="7627c-119">この例では、ランダムに生成された GUID を使用します。</span><span class="sxs-lookup"><span data-stu-id="7627c-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="7627c-120">ユーザーが [*サインイン*] ボタンを選択すると、Teams はポップアップウィンドウを開き、開始ページに移動します。</span><span class="sxs-lookup"><span data-stu-id="7627c-120">When the user selects the *signin* button, Teams opens a popup window and navigates to the start page.</span></span>
5. <span data-ttu-id="7627c-121">スタートページは、ユーザーを id プロバイダーの`authorize`エンドポイントにリダイレクトします。</span><span class="sxs-lookup"><span data-stu-id="7627c-121">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="7627c-122">([ビューコード](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span><span class="sxs-lookup"><span data-stu-id="7627c-122">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="7627c-123">プロバイダーのサイトで、ユーザーはサインインして bot へのアクセスを許可します。</span><span class="sxs-lookup"><span data-stu-id="7627c-123">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="7627c-124">プロバイダーは、ユーザーを bot の OAuth リダイレクトページに認証コードで受け取ります。</span><span class="sxs-lookup"><span data-stu-id="7627c-124">The provider takes the user to the bot's OAuth redirect page with an authorization code.</span></span>
8. <span data-ttu-id="7627c-125">Bot は、アクセストークンの認証コードを引き換えし、**条件付き**は、サインインフローを開始したユーザーにトークンを関連付けます。</span><span class="sxs-lookup"><span data-stu-id="7627c-125">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="7627c-126">次に、これを*暫定トークン*と呼びます。</span><span class="sxs-lookup"><span data-stu-id="7627c-126">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="7627c-127">この例では、bot は、サインインプロセスを`state`開始したユーザーの ID をパラメーターの値と関連付け、後で id プロバイダーによって返される`state`値と一致させることができます。</span><span class="sxs-lookup"><span data-stu-id="7627c-127">In the example, the bot associates the value of the `state` parameter with the ID of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="7627c-128">([ビューコード](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span><span class="sxs-lookup"><span data-stu-id="7627c-128">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
    * <span data-ttu-id="7627c-129">**重要**: bot は、id プロバイダーから受け取ったトークンを格納し、それを特定のユーザーに関連付けていますが、"保留中の検証" としてマークされています。</span><span class="sxs-lookup"><span data-stu-id="7627c-129">**IMPORTANT**: The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> <span data-ttu-id="7627c-130">暫定トークンはまだ使用できません。さらに検証する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7627c-130">The provisional token can't be used yet; it must be further validated:</span></span>
      1. <span data-ttu-id="7627c-131">**Id プロバイダーから受け取ったものを検証します。**</span><span class="sxs-lookup"><span data-stu-id="7627c-131">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="7627c-132">`state`パラメーターの値は、前に保存されたものに対して確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="7627c-132">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="7627c-133">**Teams からの受信を確認します。**</span><span class="sxs-lookup"><span data-stu-id="7627c-133">**Validate what's received from Teams.**</span></span> <span data-ttu-id="7627c-134">Id プロバイダーでボットを承認したユーザーが bot とチャットしているユーザーと同じユーザーであることを確認するために、 [2 段階の認証](https://en.wikipedia.org/wiki/Man-in-the-middle_attack)検証が行われます。</span><span class="sxs-lookup"><span data-stu-id="7627c-134">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="7627c-135">これにより[、man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack)および[フィッシング](https://en.wikipedia.org/wiki/Phishing)攻撃を防ぐことができます。</span><span class="sxs-lookup"><span data-stu-id="7627c-135">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="7627c-136">Bot は、検証コードを生成し、ユーザーに関連付けて保存します。</span><span class="sxs-lookup"><span data-stu-id="7627c-136">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="7627c-137">確認コードは、以下に示すように Teams によって自動的に送信されます。</span><span class="sxs-lookup"><span data-stu-id="7627c-137">The verification code is sent automatically by Teams as described below.</span></span> <span data-ttu-id="7627c-138">([ビューコード](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span><span class="sxs-lookup"><span data-stu-id="7627c-138">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="7627c-139">OAuth コールバックは、を呼び出し`notifySuccess("<verification code>")`たページをレンダリングします。</span><span class="sxs-lookup"><span data-stu-id="7627c-139">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="7627c-140">([ビューコード](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span><span class="sxs-lookup"><span data-stu-id="7627c-140">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="7627c-141">Teams はポップアップウィンドウを閉じ、送信され`<verification code>`たを`notifySuccess()` bot に送り返します。</span><span class="sxs-lookup"><span data-stu-id="7627c-141">Teams closes the pop-up window and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="7627c-142">Bot は、 `name = signin/verifyState`で[呼び出し](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke)メッセージを受信します。</span><span class="sxs-lookup"><span data-stu-id="7627c-142">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="7627c-143">Bot は、ユーザーの暫定トークンに格納されている検証コードに対して、受信確認コードをチェックします。</span><span class="sxs-lookup"><span data-stu-id="7627c-143">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="7627c-144">([ビューコード](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span><span class="sxs-lookup"><span data-stu-id="7627c-144">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="7627c-145">一致した場合、ボットはトークンを検証済みとして使用できることを示します。</span><span class="sxs-lookup"><span data-stu-id="7627c-145">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="7627c-146">それ以外の場合、認証フローは失敗し、bot が暫定トークンを削除します。</span><span class="sxs-lookup"><span data-stu-id="7627c-146">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

> [!NOTE]
> <span data-ttu-id="7627c-147">Mobile での認証に関する問題が発生した場合は、JavaScript SDK がバージョン1.4.1 以降に更新されていることを確認してください。</span><span class="sxs-lookup"><span data-stu-id="7627c-147">If you experience issues with authentication on mobile, ensure your JavaScript SDK is updated to version 1.4.1 or later.</span></span>

## <a name="samples"></a><span data-ttu-id="7627c-148">サンプル</span><span class="sxs-lookup"><span data-stu-id="7627c-148">Samples</span></span>

<span data-ttu-id="7627c-149">Bot 認証プロセスを示すサンプルコードについては、以下を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7627c-149">For sample code showing the bot authentication process see:</span></span>

* [<span data-ttu-id="7627c-150">Microsoft Teams bot 認証のサンプル (node.js)</span><span class="sxs-lookup"><span data-stu-id="7627c-150">Microsoft Teams bot authentication sample (Node.js)</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)

## <a name="more-details"></a><span data-ttu-id="7627c-151">詳細情報</span><span class="sxs-lookup"><span data-stu-id="7627c-151">More details</span></span>

<span data-ttu-id="7627c-152">Azure AD を対象とする bot 認証の実装に関する詳細なチュートリアルについては、以下を参照してください。</span><span class="sxs-lookup"><span data-stu-id="7627c-152">For detailed implementation walkthroughs for bot authentication targeting Azure AD see:</span></span>

* [<span data-ttu-id="7627c-153">Teams の bot に認証を追加する</span><span class="sxs-lookup"><span data-stu-id="7627c-153">Add authentication to your Teams bot</span></span>](add-authentication.md)
