---
title: ボットの認証フロー
description: ボットの認証フローについて説明します。
keywords: teams 認証フロー ボット
localization_priority: Normal
ms.topic: conceptual
ms.date: 03/01/2018
ms.openlocfilehash: fe7e528be98a0b58334535952327b6026b30a87d
ms.sourcegitcommit: 825abed2f8784d2bab7407ba7a4455ae17bbd28f
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/26/2021
ms.locfileid: "52019805"
---
# <a name="microsoft-teams-authentication-flow-for-bots"></a><span data-ttu-id="0c7d6-104">ボットの Microsoft Teams 認証フロー</span><span class="sxs-lookup"><span data-stu-id="0c7d6-104">Microsoft Teams authentication flow for bots</span></span>

[!include[v3-to-v4-SDK-pointer](~/includes/v3-to-v4-pointer-bots.md)]

<span data-ttu-id="0c7d6-105">OAuth 2.0 は、Azure および他の多くの ID プロバイダーが使用する認証と承認AD標準です。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure AD and many other identity providers.</span></span> <span data-ttu-id="0c7d6-106">OAuth 2.0 の基本的な理解は、Teams での認証を操作する前提条件です。 [正式な仕様よりも簡単に](https://aaronparecki.com/oauth-2-simplified/) 従える優れた概要を [次に示します](https://oauth.net/2/)。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="0c7d6-107">タブとボットの認証フローは、タブが Web サイトと非常に似ているため、OAuth 2.0 を直接使用できるので、少し異なります。また、ボットは異なる方法でいくつかの操作を行う必要がありますが、コア概念は同じです。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-107">Authentication flow for tabs and bots are a little different because tabs are very similar to websites so they can use OAuth 2.0 directly, and bots are not and must do a few things differently, but the core concepts are identical.</span></span>

<span data-ttu-id="0c7d6-108">[OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/)承認コード付与の種類を使用してノードを使用するボットの認証フローを示す例については、GitHub リポジトリ[Microsoft Teams](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)認証サンプルを参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) for an example that demonstrates authentication flow for bots using Node using the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![ボット認証シーケンス図](~/assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="0c7d6-110">ユーザーはボットにメッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="0c7d6-111">ボットは、ユーザーがサインインする必要があるかどうかを判断します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-111">The bot determines if the user needs to sign in.</span></span>
    * <span data-ttu-id="0c7d6-112">この例では、ボットはアクセス トークンをユーザー データ ストアに格納します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="0c7d6-113">選択した ID プロバイダーの検証済みトークンが存在しない場合は、ユーザーにログインを求めるメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-113">It asks the user to log in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="0c7d6-114">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span><span class="sxs-lookup"><span data-stu-id="0c7d6-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="0c7d6-115">ボットは、認証フローの開始ページへの URL を作成し、アクションを使用してユーザーにカードを送信 `signin` します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="0c7d6-116">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span><span class="sxs-lookup"><span data-stu-id="0c7d6-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span>
    * <span data-ttu-id="0c7d6-117">Teams の他のアプリケーション認証フローと同様に、スタート ページはリスト内のドメインと、ログイン後のリダイレクト ページと同じドメイン上にある `validDomains` 必要があります。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-117">Like other application auth flows in Teams, the start page must be on a domain that's in your `validDomains` list, and on the same domain as the post-login redirect page.</span></span>
    * <span data-ttu-id="0c7d6-118">**重要**: OAuth 2.0 承認コード付与フローは、一意のセッション トークンを含む認証要求内のパラメーターを呼び出して、クロスサイト要求フォージェリ攻撃を防止 `state` [します](https://en.wikipedia.org/wiki/Cross-site_request_forgery)。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-118">**IMPORTANT**: The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="0c7d6-119">この例では、ランダムに生成された GUID を使用します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="0c7d6-120">ユーザーがサインイン ボタンをクリックすると、Teams はポップアップ ウィンドウを開き、開始ページに移動します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-120">When the user clicks on the *signin* button, Teams opens a popup window and navigates it to the start page.</span></span>
5. <span data-ttu-id="0c7d6-121">スタート ページは、ユーザーを ID プロバイダーのエンドポイントにリダイレクト `authorize` します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-121">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="0c7d6-122">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span><span class="sxs-lookup"><span data-stu-id="0c7d6-122">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="0c7d6-123">プロバイダーのサイトで、ユーザーはサインインし、ボットへのアクセスを許可します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-123">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="0c7d6-124">プロバイダーは、認証コードを使用して、ユーザーをボットの OAuth リダイレクト ページに移動します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-124">The provider takes the user to the bot's OAuth redirect page, with an authorization code.</span></span>
8. <span data-ttu-id="0c7d6-125">ボットはアクセス トークンの承認コードを引き換え、サインイン フローを開始したユーザーとトークンを暫定的に関連付ける。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-125">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="0c7d6-126">以下では、これを暫定 *トークンと呼ぶ。*</span><span class="sxs-lookup"><span data-stu-id="0c7d6-126">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="0c7d6-127">この例では、ボットはパラメーターの値を、サインイン プロセスを開始したユーザーの ID に関連付け、後で ID プロバイダーによって返される値と一致することができます `state` `state` 。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-127">In the example, the bot associates the value of the `state` parameter with the id of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="0c7d6-128">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span><span class="sxs-lookup"><span data-stu-id="0c7d6-128">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
    * <span data-ttu-id="0c7d6-129">**重要**: ボットは ID プロバイダーから受け取ったトークンを格納し、それを特定のユーザーに関連付けしますが、"保留中の検証" としてマークされます。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-129">**IMPORTANT**: The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> <span data-ttu-id="0c7d6-130">暫定トークンはまだ使用できません。さらに検証する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-130">The provisional token cannot be used yet: it must be further validated:</span></span> 
      1. <span data-ttu-id="0c7d6-131">**ID プロバイダーから受け取った情報を検証します。**</span><span class="sxs-lookup"><span data-stu-id="0c7d6-131">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="0c7d6-132">パラメーターの値は `state` 、以前に保存した値に対して確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-132">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="0c7d6-133">**Teams から受け取った情報を検証します。**</span><span class="sxs-lookup"><span data-stu-id="0c7d6-133">**Validate what's received from Teams.**</span></span> <span data-ttu-id="0c7d6-134">ID [プロバイダーを使用して](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) ボットを承認したユーザーが、ボットとチャットしているユーザーと同じことを確認するために、2 段階認証の検証が実行されます。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-134">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="0c7d6-135">これにより、中間 [者や](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) フィッシング攻撃 [から保護](https://en.wikipedia.org/wiki/Phishing) されます。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-135">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="0c7d6-136">ボットは検証コードを生成し、ユーザーに関連付けられたコードを格納します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-136">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="0c7d6-137">確認コードは、手順 9 と 10 で後述するように Teams によって自動的に送信されます。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-137">The verification code is sent automatically by Teams as described below in steps 9 and 10.</span></span> <span data-ttu-id="0c7d6-138">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span><span class="sxs-lookup"><span data-stu-id="0c7d6-138">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="0c7d6-139">OAuth コールバックは、 を呼び出すページをレンダリングします `notifySuccess("<verification code>")` 。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-139">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="0c7d6-140">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span><span class="sxs-lookup"><span data-stu-id="0c7d6-140">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="0c7d6-141">Teams はポップアップを閉じ、送信 `<verification code>` されたメッセージを `notifySuccess()` ボットに送り返します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-141">Teams closes the popup and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="0c7d6-142">ボットは、 を指定して [呼び出し](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) メッセージを受信します `name = signin/verifyState` 。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-142">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="0c7d6-143">ボットは、受信検証コードを、ユーザーの暫定トークンに格納されている検証コードと照合します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-143">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="0c7d6-144">([コードの表示](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span><span class="sxs-lookup"><span data-stu-id="0c7d6-144">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="0c7d6-145">一致する場合、ボットはトークンを検証済みとしてマークし、すぐに使用できます。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-145">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="0c7d6-146">それ以外の場合、認証フローは失敗し、ボットは暫定トークンを削除します。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-146">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

> [!Note]
> <span data-ttu-id="0c7d6-147">モバイルでの認証に問題が発生した場合は、Javascript SDK がバージョン 1.4.1 以降に更新されている必要があります。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-147">If you experience issues with authentication on mobile, ensure your Javascript SDK is update to version 1.4.1 or later.</span></span>

## <a name="samples"></a><span data-ttu-id="0c7d6-148">サンプル</span><span class="sxs-lookup"><span data-stu-id="0c7d6-148">Samples</span></span>

<span data-ttu-id="0c7d6-149">ボット認証プロセスを示すサンプル コードについては、以下を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-149">For sample code showing the bot authentication process see:</span></span>

* [<span data-ttu-id="0c7d6-150">Microsoft Teams ボット認証サンプル (ノード)</span><span class="sxs-lookup"><span data-stu-id="0c7d6-150">Microsoft Teams bot authentication sample (Node)</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)

## <a name="more-details"></a><span data-ttu-id="0c7d6-151">詳細情報</span><span class="sxs-lookup"><span data-stu-id="0c7d6-151">More details</span></span>

<span data-ttu-id="0c7d6-152">Azure Active Directory を対象としたボット認証の詳細な実装のチュートリアルについては、以下を参照してください。</span><span class="sxs-lookup"><span data-stu-id="0c7d6-152">For detailed implementation walkthroughs for bot authentication targeting Azure Active Directory see:</span></span>

* [<span data-ttu-id="0c7d6-153">Microsoft Teams ボットでユーザーを認証する</span><span class="sxs-lookup"><span data-stu-id="0c7d6-153">Authenticate a user in a Microsoft Teams bot</span></span>](~/resources/bot-v3/bot-authentication/auth-bot-AAD.md)
